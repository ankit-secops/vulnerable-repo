name: 'Veracode Secrets Scanning'

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  veracode-secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Veracode Container/IaC/Secrets Scan
        id: scan
        uses: veracode/container_iac_secrets_scanning@v1.0.4
        with:
          vid:  ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          command: 'scan'
          type: 'directory'
          source: './'
          format: 'json'
          debug: false

      - name: Upload scan results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-secrets-results
          path: 'results.json'
          if-no-files-found: ignore

      # ğŸ‘‰ NEW STEP: Fail if secrets are found
      - name: âŒ Fail if secrets detected
        run: |
          if grep -qi "\"secret\"" results.json; then
            echo "âŒ ALERT: Secrets were detected in the scan!"
            echo "Failing the pipeline."
            exit 1
          fi
        shell: bash

      - name: âœ… No Secrets Found - Scan Passed
        if: success()
        run: |
          echo "âœ… Veracode scan passed - No secrets detected!"
