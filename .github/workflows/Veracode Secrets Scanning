name: 'Veracode Secrets Scanning'
on:
  push:
    branches:
        - main
        - master
        - develop
  pull_request:
permissions:
  contents: read
  security-events: write
  pull-requests: write
jobs:
  veracode-secrets-scan:
    runs-on: ubuntu-latest
    steps:
        - name: 'Checkout code'
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: 'Run Veracode Container/IaC/Secrets Scan'
          id: scan
          uses: veracode/container_iac_secrets_scanning@v1.0.4
          with:
            # Your Veracode API credentials (from repository secrets)
            vid:  ${{ secrets.VID }}
            vkey: ${{ secrets.VKEY }}
            # Scan command (detect issues in this repo)
            command: 'scan'
            # Type of source to scan
            type: 'directory'
            # Scan everything in the repository
            source: './'
            # Output format for results
            format: 'json'
            # CRITICAL: Fail the workflow if ANY secrets found
            fail_build: true
            # Show debug information
            debug: false
        - name: 'Upload scan results artifact'
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: veracode-secrets-results
            path: 'results.json'
            if-no-files-found: ignore
        - name: '❌ Secrets Detected - Fail PR'
          if: failure() && steps.scan.outcome == 'failure'
          run: |
            echo "❌ ALERT: Veracode detected SECRETS in this code!"
            echo ""
            echo "Actions required:"
            echo "1. Remove all secrets from the code"
            echo "2. Rotate any exposed credentials immediately"
            echo "3. Force push the cleaned code"
            echo "4. Try again"
            exit 1
        - name: '✅ No Secrets Found - Scan Passed'
          if: success()
          run: |
            echo "✅ Veracode scan passed - No secrets detected!"
